<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title th:text="${employeeId} != null ? 'Edit Employee' : 'Promote User to Employee'">Employee</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"/>
    <style>
        body{background:linear-gradient(135deg,#0d6efd,#6c63ff);min-height:100vh;margin:0;display:flex;align-items:center;justify-content:center}
        .card{border:none;border-radius:20px;box-shadow:0 8px 30px rgba(0,0,0,.12);width:100%;max-width:820px}
        .card-header{border:0;border-radius:20px 20px 0 0;background:#fff}
        .badge-soft{background:rgba(13,110,253,.08);color:#0d6efd;border-radius:8px;padding:.35rem .6rem;font-weight:600}
    </style>
</head>
<body>
<div class="card m-3">
    <div class="card-header d-flex justify-content-between align-items-center">
        <div>
            <h3 class="mb-1 text-primary" th:text="${employeeId} != null ? 'Edit Employee' : 'Promote User to Employee'">Promote</h3>
            <small class="text-muted" th:text="${employeeId} != null ?
          'Update position/office assignment' :
          'Grant EMPLOYEE role and assign position/office'">Subtitle</small>
        </div>
        <div class="d-flex gap-2">
            <a class="btn btn-outline-secondary" th:href="@{/reports/employees}">Back to Report</a>
            <a class="btn btn-outline-primary" th:href="@{/}">Home</a>
        </div>
    </div>

    <div class="card-body">

        <!-- Flash messages (optional: add in controller as RedirectAttributes) -->
        <div th:if="${success}" class="alert alert-success py-2 mb-3" th:text="${success}">Saved.</div>
        <div th:if="${error}" class="alert alert-danger py-2 mb-3" th:text="${error}">Error.</div>

        <!-- Unified form -->
        <form class="row g-3"
              th:action="${employeeId} != null ? @{|/admin/employees/edit/${employeeId}|} : @{/admin/employees}"
              th:object="${form}" method="post">

            <!-- CREATE MODE: choose existing user by email -->
            <div class="col-12" th:if="${employeeId} == null">
                <label class="form-label">Select User <span class="badge-soft ms-1">required</span></label>
                <div class="d-flex gap-2">
                    <input id="userFilter" type="search" class="form-control" placeholder="Quick filter by name or email…" oninput="filterUsers()">
                </div>
                <select id="userSelect" class="form-select mt-2" th:field="*{email}" required>
                    <option value="">Select a user…</option>
                    <option th:each="u : ${users}"
                            th:value="${u.email}"
                            th:data-name="${u.fullName}"
                            th:text="${u.fullName + ' (' + u.email + ')'}">
                    </option>
                </select>
                <div class="form-text">User will receive the <strong>EMPLOYEE</strong> role after promotion.</div>
            </div>

            <!-- EDIT MODE: show read-only email -->
            <div class="col-12" th:if="${employeeId} != null">
                <label class="form-label">User Email</label>
                <input class="form-control" th:value="${form.email}" readonly>
                <div class="form-text">The user’s identity can’t be changed for an existing employee.</div>
            </div>

            <!-- Position -->
            <div class="col-12 col-md-6">
                <label class="form-label">Position</label>
                <input class="form-control" th:field="*{position}" placeholder="Courier / Office Staff / Manager">
            </div>

            <!-- Company -->
            <div class="col-12 col-md-6">
                <label class="form-label">Company</label>
                <select id="companySelect" class="form-select" th:field="*{companyId}">
                    <option value="">—</option>
                    <option th:each="c : ${companies}" th:value="${c.id}" th:text="${c.name}"></option>
                </select>
                <div class="form-text">Selecting a company narrows the office choices below.</div>
            </div>

            <!-- Office (filtered by company on client-side) -->
            <div class="col-12">
                <label class="form-label">Office</label>
                <select id="officeSelect" class="form-select" th:field="*{officeId}">
                    <option value="">—</option>
                    <option th:each="o : ${offices}"
                            th:value="${o.id}"
                            th:data-company-id="${o.company != null ? o.company.id : 0}"
                            th:text="${o.city + ' — ' + o.addressLine}">
                    </option>
                </select>
            </div>

            <div class="col-12 d-flex gap-2 mt-2">
                <button class="btn btn-primary" type="submit"
                        th:text="${employeeId} != null ? 'Update Employee' : 'Promote to Employee'">Save</button>
                <a class="btn btn-outline-secondary" th:href="@{/reports/employees}">Cancel</a>
            </div>
        </form>
    </div>
</div>

<script>
    // Quick filter for users (create mode)
    function filterUsers(){
      const q = (document.getElementById('userFilter').value || '').toLowerCase();
      const select = document.getElementById('userSelect');
      if(!select) return;
      [...select.options].forEach((opt, idx) => {
        if(idx === 0){ opt.hidden = false; return; } // keep placeholder visible
        const label = (opt.text || '').toLowerCase();
        const name  = (opt.getAttribute('data-name') || '').toLowerCase();
        opt.hidden = !(label.includes(q) || name.includes(q));
      });
    }

    // Filter offices by selected company
    (function(){
      const companySel = document.getElementById('companySelect');
      const officeSel  = document.getElementById('officeSelect');
      if(!companySel || !officeSel) return;

      function applyOfficeFilter(){
        const companyId = companySel.value || '';
        let anyVisible = false;
        [...officeSel.options].forEach((opt, idx) => {
          if(idx === 0){ opt.hidden = false; return; } // placeholder
          const optCompanyId = opt.getAttribute('data-company-id') || '';
          const show = (companyId === '' || companyId === optCompanyId);
          opt.hidden = !show;
          if(show) anyVisible = true;
        });
        // If current selection is hidden, reset to placeholder
        const current = officeSel.selectedOptions[0];
        if(current && current.hidden) officeSel.selectedIndex = 0;
      }

      companySel.addEventListener('change', applyOfficeFilter);
      // Run once on load to respect pre-selected company in edit mode
      applyOfficeFilter();
    })();
</script>
</body>
</html>